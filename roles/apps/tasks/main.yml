---
# Role: apps
# Grid item: Pods creation (2 pts)
# Deploys nginx with 3 replicas to prove pod scheduling works

- name: Copy nginx manifest
  copy:
    src: nginx-app.yml
    dest: /tmp/nginx-app.yml

- name: Deploy nginx application
  command: kubectl apply -f /tmp/nginx-app.yml
  environment:
    KUBECONFIG: /root/.kube/config

- name: Wait for nginx rollout
  command: kubectl rollout status deployment/nginx-app --timeout=180s
  environment:
    KUBECONFIG: /root/.kube/config

- name: Show all pods across all namespaces
  command: kubectl get pods -A -o wide
  environment:
    KUBECONFIG: /root/.kube/config
  register: all_pods

- name: Display all pods
  debug:
    msg: "{{ all_pods.stdout_lines }}"

- name: Show all services
  command: kubectl get svc -A
  environment:
    KUBECONFIG: /root/.kube/config
  register: all_svc

- name: Display services
  debug:
    msg: "{{ all_svc.stdout_lines }}"

- name: Final deployment summary
  debug:
    msg:
      - "=========================================="
      - "  4SAYA DEPLOYMENT COMPLETE"
      - "=========================================="
      - "  Nginx:        http://<NODE_IP>:30080"
      - "  Grafana:      http://<NODE_IP>:32000"
      - "  Alertmanager: http://<NODE_IP>:31000"
      - "=========================================="
      - "  kubectl get nodes"
      - "  kubectl get pods -A"
      - "  kubectl top nodes"
      - "  kubectl top pods -A"
      - "=========================================="
